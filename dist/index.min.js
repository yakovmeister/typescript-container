"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var isInstantiable=function(t){return"object"==typeof t.prototype&&"function"==typeof Reflect.get(t.prototype,"constructor")},ContextualBindingBuilder=function(){function t(t,e){this.container=t,this.concrete=e}return t.prototype.needs=function(t){return this.abstract=t,this},t.prototype.provide=function(t){this.container.addContextualBinding(this.concrete,this.abstract,t)},t}(),end=function(t){return t[t.length-1]},Container=function(){function e(){var e=this;this._resolved=[],this.bindings=[],this.instances=[],this.aliases=[],this.buildStack=[],this.abstractAliases=[],this.contextual=[],this.with=[],this.resolveClass=function(t){if(!isInstantiable(t))throw new Error("["+t+"] is not instantiable");return e.make(t)}}return e.prototype.isBuildable=function(t,e){return t===e||"function"==typeof t},e.prototype.getDependecies=function(t,e){return this.sortAndGetArguments(t[e])},e.prototype.resolveDependencies=function(t){return t.map(this.resolveClass)},e.prototype.injectMethodsDependecies=function(i){var s=this,t=Object.getPrototypeOf(i);return this.iterateThroughMethods(t,function(t){var e=t[0];if("function"==typeof t[1]){var n=s.prepareDependenciesResolution(i,e);i[e]=s.injectDependency(i[e],n)}}),i},e.prototype.iterateThroughMethods=function(t,e){return Object.entries(t).forEach(e)},e.prototype.prepareDependenciesResolution=function(t,e){var n="inject__"+e+"_params",i=this.sortAndGetArguments(t[n]);return this.resolveDependencies(i)},e.prototype.injectDependency=function(t,i){return void 0===i&&(i=[]),new Proxy(t,{apply:function(t,e,n){return Reflect.apply(t,e,i.concat(n))}})},e.prototype.sortAndGetArguments=function(t){return Array.isArray(t)?t.sort(function(t){return t.index}).map(function(t){return t.value}):[]},e.prototype.getAlias=function(t){if(!this.aliases[t])return t;if(this.aliases[t]===t)throw new Error("["+t+"] is aliased on it's own.");return this.getAlias(this.aliases[t])},e.prototype.when=function(t){return new ContextualBindingBuilder(this,this.getAlias(t))},e.prototype.removeAbstractAlias=function(i){var s=this;this.aliases[i]&&this.abstractAliases.forEach(function(t,n){t.forEach(function(t,e){t===i&&delete s.abstractAliases[n][e]})})},e.prototype.instance=function(t,e){this.removeAbstractAlias(t);var n=this.bound(t);return delete this.aliases[t],this.instances[t]=e,n&&this.rebound(t),e},e.prototype.build=function(t){if(!isInstantiable(t))return this.notInstantiable(t);this.buildStack.push(t);var e=this.getDependecies(t,"inject__constructor_params");e=this.resolveDependencies(e);var n=Reflect.construct(t,e);return n=this.injectMethodsDependecies(n),this.buildStack.pop(),n},e.prototype.resolve=function(t,e){void 0===e&&(e=[]),t=this.getAlias(t);var n=!!e.length||!!this.getContextualConcrete(t);if(this.instances[t]&&!n)return this.instances[t];this.with.push(e);var i=this.getConcrete(t),s=this.isBuildable(i,t)?this.build(i):this.make(i);return this.isShared(t)&&!n&&(this.instances[t]=s),this._resolved[t]=!0,this.with.pop(),s},e.prototype.getConcrete=function(t){var e=this.getContextualConcrete(t);return e||(this.bindings[t]?this.bindings[t].concrete:t)},e.prototype.getContextualConcrete=function(t){var n=this,e=this.findInContextualBindings(t);return e||(this.abstractAliases[t]?this.abstractAliases[t].forEach(function(t){var e=n.findInContextualBindings(t);if(e)return e}):void 0)},e.prototype.findInContextualBindings=function(t){if(this.contextual[end(this.buildStack)]&&this.contextual[end(this.buildStack)][t])return this.contextual[end(this.buildStack)][t]},e.prototype.isAlias=function(t){return!!this.aliases[t]},e.prototype.alias=function(t,e){this.aliases[e]=t,Array.isArray(this.abstractAliases[t])||(this.abstractAliases[t]=[]),this.abstractAliases[t].push(e)},e.prototype.make=function(t,e){return void 0===e&&(e=[]),this.resolve(t)},e.prototype.singleton=function(t,e){void 0===e&&(e=null),this.attach(t,e,!0)},e.prototype.attach=function(t,e,n){void 0===e&&(e=null),void 0===n&&(n=!1),this.dropStaleInstances(t),e||(e=t),this.bindings[t]={concrete:e,shared:n},this.resolved(t)&&this.rebound(t)},e.prototype.rebound=function(t){this.make(t)},e.prototype.bound=function(t){return!!this.bindings[t]||!!this.instances[t]||this.isAlias(t)},e.prototype.isShared=function(t){return!!this.instances[t]||!!this.bindings[t]&&!!this.bindings[t].shared},e.prototype.resolved=function(t){if(this.isAlias(t))t=this.getAlias(t);return!!this._resolved[t]||!!this.instances[t]},e.prototype.get=function(t){if(this.bound(t))return this.resolve(t);throw new Error("Entry not found")},e.prototype.attachIf=function(t,e,n){void 0===e&&(e=null),void 0===n&&(n=!1),this.bound(t)||this.attach(t,e,n)},e.prototype.dropStaleInstances=function(t){delete this.instances[t],delete this.aliases[t]},e.prototype.factory=function(t){return function(t){return this.make(t)}.bind(this,t)},e.prototype.addContextualBinding=function(t,e,n){this.contextual[t]||(this.contextual[t]={}),this.contextual[t][this.getAlias(e)]=n},e.getInstance=function(){return e.instance||(e.instance=new e),e.instance},e.setInstance=function(t){e.instance=t},e.prototype.forgetInstance=function(t){delete this.instances[t]},e.prototype.forgetInstances=function(){this.instances=[]},e.prototype.flush=function(){this.aliases=[],this._resolved=[],this.bindings=[],this.instances=[],this.abstractAliases=[]},e.prototype.notInstantiable=function(t){var e="";this.buildStack?e="Target ["+t+"] is not instantiable while building ["+this.buildStack.join(", ")+"].":e="Target ["+t+"] is not instantiable.";throw new Error(e)},e}(),Inject=function(s){return function(t,e,n){var i="inject__"+(e||"constructor")+"_params";Array.isArray(t[i])?t[i].push({index:n,value:s}):t[i]=[{index:n,value:s}]}};exports.default=Container,exports.Inject=Inject;
